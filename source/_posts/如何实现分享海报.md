---
title: å¦‚ä½•å®ç°åˆ†äº«æµ·æŠ¥
date: 2022-06-30 15:56:15
tags: [react, h5]
category: react
description: åœ¨å®ç°h5é¡µé¢æ—¶ï¼Œå¦‚æœäº§å“éœ€è¦æˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªåˆ†äº«æµ·æŠ¥ç”¨äºåˆ†äº«ç»™ç”¨æˆ·ä»è€Œå¼•æµï¼Œé‚£æˆ‘ä»¬è¯¥æ€ä¹ˆå»å®ç°è¿™ä¸ªåˆ†äº«æµ·æŠ¥å‘¢ï¼ŸğŸ¤”
---

## å‰è¨€
ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå…³äºå‰ç«¯ç”Ÿæˆæµ·æŠ¥çš„é—®é¢˜ï¼Œä¸€èˆ¬æˆ‘ä»¬åˆ¶ä½œæµ·æŠ¥ï¼Œéƒ½ä¼šé€‰æ‹©å‰ç«¯è¿›è¡Œç”Ÿæˆã€‚å°†éœ€è¦åˆ†äº«å‡ºå»çš„éƒ¨åˆ†çš„domç›´æ¥ç”Ÿæˆå›¾ç‰‡ï¼Œç„¶åæŠŠè¿™ä¸ªå›¾ç‰‡åˆ†äº«ç»™ç”¨æˆ·ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨çš„æ˜¯`html2canvas`è¿™ä¸ªåº“ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸‹

> html2canvasæ–‡æ¡£åœ¨è¿™é‡Œ http://html2canvas.hertzen.com
> 
> æŸ¥çœ‹æœ¬æ–‡çš„å®Œæ•´ä»£ç å¯ç›´æ¥ç§»æ­¥åˆ°æ–‡ç« æœ«å°¾

## åŠ¨æ‰‹æ—¶é—´ï¼ˆæŒ–å‘æ—¶é—´ï¼‰
æ ¹æ®å®˜æ–¹æ–‡æ¡£å®‰è£…ä¾èµ–

```bash
yarn add html2canvas
```

å‡è®¾ä¸‹é¢å°±æ˜¯æˆ‘ä»¬è¦ç”Ÿæˆçš„æµ·æŠ¥å†…å®¹

```javascript
// from https://mobile.ant.design/zh/components/image
const demoSrc = 
  'https://images.unsplash.com/photo-1567945716310-4745a6b7844b?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1500&q=60'

function SharePoster() {

  return <div ref={wrapperRef} className='share-poster'>
    {/**å•†å“çš„å›¾ç‰‡ */}
    <img src={demoSrc} className='share-poster--img' onLoad={imgeLoad}/>
    <div>è¿™æ˜¯æ ‡é¢˜</div>
    <div>è¿™æ˜¯å¦ä¸€ä¸ªæ ‡é¢˜</div>
    <div>è¿™æ˜¯è¿˜æ˜¯ä¸€ä¸ªæ ‡é¢˜</div>
  </div>
}

export default SharePoster
```

ç°åœ¨ï¼Œå†…å®¹æœ‰äº†ï¼Œè¯¥æ˜¯ç”Ÿç«...ä¸å¯¹ï¼Œè¯¥æ˜¯ç”Ÿæˆæµ·æŠ¥çš„æ—¶å€™äº†ï¼Œæ·»åŠ `html2canvas`
```javascript
import html2canvas from 'html2canvas'
import { useRef } from "react"
import './index.less'

const demoSrc = 
  'https://images.unsplash.com/photo-1567945716310-4745a6b7844b?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1500&q=60'


function SharePoster() {
  const wrapperRef = useRef(null)

  // ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ
  const imgeLoad = () => {
    if (wrapperRef.current) {
      html2canvas(wrapperRef.current, {
        useCORS: true
      }).then(canvas => {
        // å°†ç”Ÿæˆçš„canvasè½¬æ¢æˆbase64
        const base64 = canvas.toDataURL('image/png')
        // åˆ°è¿™é‡Œæˆ‘ä»¬çš„æµ·æŠ¥å°±ç”Ÿæˆäº†
        console.log(base64)

        // ä¸‹è½½åˆ°æœ¬åœ°
        // const a = document.createElement('a')
        // a.href = base64
        // a.download = +new Date() + '.png'
        // a.click()
      })
    }
  }

  return <div ref={wrapperRef} className='share-poster'>
    {/**å•†å“çš„å›¾ç‰‡ */}
    <img src={demoSrc} className='share-poster--img' onLoad={imgeLoad}/>
    <div>è¿™æ˜¯æ ‡é¢˜</div>
    <div>è¿™æ˜¯å¦ä¸€ä¸ªæ ‡é¢˜</div>
    <div>è¿™æ˜¯è¿˜æ˜¯ä¸€ä¸ªæ ‡é¢˜</div>
  </div>
}

export default SharePoster
```

æ­å–œğŸ‰ğŸ‰ğŸ‰ï¼Œä½ åœ¨1åˆ†é’Ÿä¸åˆ°çš„æ—¶é—´ï¼Œå°±å®Œæˆäº†äº§å“çš„éœ€æ±‚ï¼Œæˆ‘ä»¬ç°åœ¨å‘å¸ƒåˆ°çº¿ä¸Šå§

æµ‹è¯•ï¼šæˆ‘è¯´å¤§å…„å¼Ÿå‘€ï¼Œä½ è¿™å†™çš„å•¥å‘€ï¼Œä¸‹è½½ä¸‹æ¥çš„æµ·æŠ¥ï¼Œé™¤äº†æ–‡å­—ï¼Œå•†å“å›¾ç‰‡éƒ½æ²¡æœ‰ï¼Œä½ æ˜¯åœ¨ç©æˆ‘å—ï¼Ÿ


ï¼ï¼ï¼å’‹å›äº‹ï¼Œæœ¬åœ°ç¯å¢ƒä¸æ˜¯æ²¡æ¯›ç—…å—

## å¡«å‘æ—¶é—´
é¦–å…ˆæˆ‘ä»¬æœ‰äº†è§£åˆ°[canvasä¸æ”¯æŒåŠ è½½è·¨åŸŸçš„å›¾ç‰‡èµ„æº](https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image)ï¼Œcanvasä¼šè®¤ä¸ºè¿™å›æ±¡æŸ“ç”»å¸ƒï¼Œè€Œhtml2canvasç”¨åˆ°äº†canvasï¼Œæ‰€ä»¥å°±å­˜åœ¨è½¬æ¢å›¾ç‰‡æ—¶å‡ºé”™ã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»å¦ä¸€ä¸ªæ–¹å‘æ€è€ƒï¼Œæ—¢ç„¶ä¸è®©ç›´æ¥åŠ è½½å›¾ç‰‡ï¼Œé‚£æˆ‘ä»¬åŠ è½½base64çš„å›¾ç‰‡æ€»å¯ä»¥å§

å°†å›¾ç‰‡è½¬æ¢æˆbase64

```javascript
// from https://www.w3docs.com/snippets/javascript/how-to-convert-the-image-into-a-base64-string-using-javascript.html
function toDataUrl(src, callback) {
  const image = new Image()
  // æ‰§è¡Œä¸€ä¸ªè·¨åŸŸè¯·æ±‚
  // https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/img#attr-crossorigin
  image.crossOrigin = 'Anonymous'
  image.onload = function () {
    const canvas = document.createElement('canvas')
    const ctx = canvas.getContext('2d')
    // å°†å›¾ç‰‡ç”»åˆ°canvasä¸­
    ctx.drawImage(image, 0, 0);
    const dataURL = canvas.toDataURL('image/png')

    callback(dataURL)
  }
  // åŠ è½½å›¾ç‰‡
  image.src = src
}
```

æ›´æ”¹`SharePoster`ç»„ä»¶

```javascript
  // ....
  const [base64, setBase64] = useState('')

  useEffect(() => {
    toDataUrl(demoSrc, setBase64)
  }, [])

  // ç­‰å¾…å›¾ç‰‡è½¬æ¢æˆbase64
  if (!base64) {
    return null
  }

  return <div ref={wrapperRef} className='share-poster'>
    {/**å•†å“çš„å›¾ç‰‡ */}
    {/**ç°åœ¨è¿™é‡Œä½¿ç”¨base64ï¼Œè€Œä¸æ˜¯å›¾ç‰‡åœ°å€ */}
    <img src={base64} className='share-poster--img' onLoad={imgeLoad}/>
    <div>è¿™æ˜¯æ ‡é¢˜</div>
    <div>è¿™æ˜¯å¦ä¸€ä¸ªæ ‡é¢˜</div>
    <div>è¿™æ˜¯è¿˜æ˜¯ä¸€ä¸ªæ ‡é¢˜</div>
  </div>
```

å¯¹äºåšäº†cdnå¤„ç†çš„å›¾ç‰‡ï¼Œéœ€è¦åœ¨å›¾ç‰‡èµ„æºå°¾éƒ¨åŠ ä¸ªæ—¶é—´æˆ³ï¼Œé¿å…åŠ è½½ç¼“å­˜å¯¼è‡´ç”Ÿæˆæµ·æŠ¥å¤±è´¥
```javascript
// ...

  useEffect(() => {
    toDataUrl(demoSrc + 'v=' + +new Date(), setBase64)
  }, [])
// ...
```

> å®Œæ•´ä»£ç  https://codesandbox.io/s/share-poster-vg3gt6



